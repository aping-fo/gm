<div class="pageHeader">
    <form id="pagerForm" onsubmit="return navTabSearch(this);" action="statics/leave_distribution" method="post"
          onreset="$(this).find('select.combox').comboxReset()">
        <div th:fragment="searchBar" id="leaveDistribution">
            <input id="serverIds" type="hidden" name="serverIds" th:value="${#strings.listJoin(request.serverIds,',')}"/>
            <input id="channelIds" type="hidden" name="channelIds" th:value="${#strings.listJoin(request.channelIds,',')}"/>
            <input type="hidden" name="orderField" th:value="${request.orderField}"/>
            <input type="hidden" name="orderDirection" th:value="${request.orderDirection}"/>
            <input id="pageNum" type="hidden" name="pageNum" th:value="${Pager.pageNum}"/>
            <input type="hidden" name="pageSize" th:value="${Pager.pageSize}"/>
            <div class="searchBar">
                <table class="searchContent">
                    <tr>
                        <td>
                            <div>
                                <div class="buttonContent">
                                    <a class="button" href="server/select" rel="serverselect" mask="true" lookupGroup=""><span>区服筛选</span></a>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>
                                <div class="buttonContent">
                                    <a class="button" href="channel/select" rel="channelselect" mask="true" lookupGroup=""><span>渠道筛选</span></a>
                                </div>
                            </div>
                        </td>
                        <td>平台:
                            <select name="platform">
                                <option value="">全部</option>
                                <option value="1" th:selected="${request.platform==1}">安卓</option>
                                <option value="2" th:selected="${request.platform==2}">IOS</option>
                            </select>
                        </td>
                        <td class="date">
                            日期:
                            <input th:if="${request.date} eq'now()'" name="date" class="date readonly" readonly="readonly" type="text">
                            <input th:if="${request.date} ne'now()'" name="date" class="date readonly" readonly="readonly" type="text" value="" th:value="${request.date}">
                        </td>
                        <td>等级>=
                            <input name="level" type="number" value="" th:value="${request.level}">
                        </td>
                        <td>
                            <div class="buttonActive">
                                <div class="buttonContent">
                                    <button type="submit">检索</button>
                                </div>
                            </div>
                        </td>
                        <td>
                            <a class="button" onclick="exportExcel(this)"><span>导出EXCEL</span></a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </form>
</div>
<div class="pageContent">
    <table class="table" width="100%" layoutH="137">
        <thead>
        <tr id="leaveDistributionTitle">
            <input type="hidden" th:each="row,iterStat:${list}" th:value="${row.date}"/>
            <th width="100">日期</th>
            <th width="100">等级</th>
            <th width="100">用户数</th>
            <th width="100">占比</th>
            <th width="100">活跃用户数</th>
            <th width="100">活跃用户数占比</th>
            <th width="100">付费用户数</th>
            <th width="100">付费用户数占比</th>
        </tr>
        </thead>
        <tbody>
        <tr th:if="${list.size()!=0}" th:each="row,iterStat:${list}">
            <td th:text="${row.date}"></td>
            <td th:text="${row.level}"></td>
            <td th:text="${row.userNumber}"></td>
            <td th:if="${row.userRate>=1}">100.00%</td>
            <td th:if="${row.userRate>0 and row.userRate<1}" th:text="${#strings.append(#strings.substring(row.userRate*100,0,4),'%')}"></td>
            <td th:if="${row.userRate<=0}">0.00%</td>
            <td th:text="${row.activeNumber}"></td>
            <td th:if="${row.activeRate>=1}">100.00%</td>
            <td th:if="${row.activeRate>0 and row.activeRate<1}" th:text="${#strings.append(#strings.substring(row.activeRate*100,0,4),'%')}"></td>
            <td th:if="${row.activeRate<=0}">0.00%</td>
            <td th:text="${row.payNumber}"></td>
            <td th:if="${row.payRate>=1}">100.00%</td>
            <td th:if="${row.payRate>0 and row.payRate<1}" th:text="${#strings.append(#strings.substring(row.payRate*100,0,4),'%')}"></td>
            <td th:if="${row.payRate<=0}">0.00%</td>
        </tr>
        <tr th:if="${list.size()==0}"><td colspan="8" style="text-align: center">暂无数据</td></tr>
        </tbody>
    </table>
    <div th:replace="_include/pager"></div>
</div>
<script type="text/javascript">
    function exportExcel(flag) {
        var filename='等级分布'+$('#leaveDistributionTitle input').val()+'.xls';

        var title=new Array();
        var titles=$('#leaveDistributionTitle th');
        for(var i=0; i<titles.length; i++){
            title.push(titles.eq(i).text());
        }

        var channelIds=$('#leaveDistribution #channelIds').val()
        var serverIds=$('#leaveDistribution #serverIds').val()
        var platform=$('#leaveDistribution select[name="platform"]').val()
        var date=$('#leaveDistribution input[name="date"]').val()
        var level=$('#leaveDistribution input[name="level"]').val()
        var pageNum=$('#leaveDistribution #pageNum').val()

        $(flag).attr("href","statics/download?&filename="+filename+"&title="+title+"&channelIds="+channelIds+"&serverIds="+serverIds+"&platform="+platform+"&date="+date+"&level="+level+"&pageNum="+pageNum);
    }
</script>
